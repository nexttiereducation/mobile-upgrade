"use strict";var __decorate=this&&this.__decorate||function(e,t,r,o){var n,i=arguments.length,s=i<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,r):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,o);else for(var a=e.length-1;0<=a;a--)(n=e[a])&&(s=(i<3?n(s):3<i?n(t,r,s):n(t,r))||s);return 3<i&&s&&Object.defineProperty(t,r,s),s},__awaiter=this&&this.__awaiter||function(i,s,a,l){return new(a||(a=Promise))(function(e,t){function r(e){try{n(l.next(e))}catch(e){t(e)}}function o(e){try{n(l.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,o)}n((l=l.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(r,o){function e(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(s=i[2&t[0]?"return":t[0]?"throw":"next"])&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[0,s.value]),t[0]){case 0:case 1:s=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(s=0<(s=a.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){a.label=t[1];break}if(6===t[0]&&a.label<s[1]){a.label=s[1],s=t;break}if(s&&a.label<s[2]){a.label=s[2],a.ops.push(t);break}s[2]&&a.ops.pop(),a.trys.pop();continue}t=o.call(r,a)}catch(e){t=[6,e],i=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}var n,i,s,t,a={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t};Object.defineProperty(exports,"__esModule",{value:!0});var core_1=require("@angular/core"),lodash_1=require("lodash"),rxjs_1=require("rxjs"),map_1=require("rxjs/internal/operators/map"),tap_1=require("rxjs/internal/operators/tap"),stakeholder_model_1=require("@nte/models/stakeholder.model"),StakeholderService=function(){function e(e,t,r,o,n,i,s,a){this.api=e,this.apiToken=t,this.nodeApi=r,this.storage=o,this.highSchoolService=n,this.mixpanel=i,this.pnService=s,this.toastService=a,this.newUser={email:null,first_name:null,last_name:null,password:null,stakeholder_type:null},this._loggingIn=new rxjs_1.BehaviorSubject(!1),this._loggedIn=new rxjs_1.BehaviorSubject(!1),this._loginSuccess=new rxjs_1.Subject,this._logoutSuccess=new rxjs_1.Subject,this._overview=new rxjs_1.BehaviorSubject(null),this._stakeholder=new rxjs_1.BehaviorSubject(null),this.stakeholder=new stakeholder_model_1.Stakeholder({})}return Object.defineProperty(e.prototype,"loggedIn",{get:function(){return this._loggedIn.getValue()},set:function(e){this._loggedIn.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"loggedIn$",{get:function(){return this._loggedIn.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"loggingIn",{get:function(){return this._loggingIn.getValue()},set:function(e){this._loggingIn.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"loggingIn$",{get:function(){return this._loggingIn.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"loginSuccess",{get:function(){return this._loginSuccess.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"logoutSuccess",{get:function(){return this._logoutSuccess.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"overview",{get:function(){return this._overview.getValue()},set:function(e){this._overview.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"overview$",{get:function(){return this._overview.asObservable()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stakeholder",{get:function(){return this._stakeholder.getValue()},set:function(e){this._stakeholder.next(e)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"stakeholder$",{get:function(){return this._stakeholder.asObservable()},enumerable:!0,configurable:!0}),e.prototype.checkStorage=function(){var o=this;return this.storage.getObject("ls.stakeholder").then(function(r){return!!r&&(o.storage.getItem("ls.token").then(function(e){if(e&&e.value&&e.value.length){var t=r;o.setStakeholder({id:t.id,token:e.value},!0)}}),!0)},function(e){return!1})},e.prototype.changePassword=function(e,t,r){return this.api.post("/stakeholder/password/change/",{new_password:t,new_password_confirm:r,old_password:e})},e.prototype.deleteUser=function(){var e=this;this.api.delete("/stakeholder/").subscribe(function(){return e.logout()})},e.prototype.getCleverAuthToken=function(e){var t=this,r=e||{};return this.api.postWithoutAuthorization("/clever/login/",r).subscribe(function(e){return t.setStakeholder(e,!0,"clever")},function(e){return console.error(e)})},e.prototype.getGraduationYearOptions=function(){return this.api.optionsNoAuth("/stakeholder/register/").pipe(map_1.map(function(e){return e.actions.POST.graduation_year}))},e.prototype.getNewUserForRegistration=function(){return this.newUser.graduation_year=this.newUser.graduation.year,this.newUser.phase=this.newUser.graduation.phase,delete this.newUser.graduation,this.newUser},e.prototype.getOverview=function(){var t=this;return this.stakeholder&&this.stakeholder.id?this.nodeApi.get("/users/"+this.stakeholder.id+"/overview").pipe(map_1.map(function(e){return t.overview=e,t.overview})):new rxjs_1.Observable(null)},e.prototype.getStakeholderInformation=function(t,r){var o=this;this.api.get("/stakeholder").subscribe(function(e){return o.stakeholder=new stakeholder_model_1.Stakeholder(e),o.loggedIn=!0,o.stakeholder.loggedIn=!0,o.storage.getItem("ls.token").then(function(e){o.stakeholder.authToken=e.value}),o.stakeholder.id=e.id,o.populateEntitlements(),o.mixpanel.start(o.stakeholder),o.stakeholder.highschool&&o.setHighSchool(),t&&("clever"===r?o.mixpanel.event("logged_in_with_clever"):o.mixpanel.event("logged_in_with_basic_login")),o.stakeholder})},e.prototype.getStudentsForParent=function(e){var t=this;return void 0===e&&(e=""),this.api.get("/students/"+e).pipe(map_1.map(function(e){return e.results}),tap_1.tap(function(e){return t.stakeholder.students=e}))},e.prototype.login=function(e){var t=this;this.loggingIn=!0,this.api.postWithoutAuthorization("/stakeholder/login/",e).subscribe(function(e){t.setStakeholder(e,!0),t.apiToken.token=e.token},function(e){t.loggingIn=!1,t.showLoginErrorToast(e)})},e.prototype.loginViaStorage=function(){var t=this;this.storage.getItem("ls.token").then(function(e){e&&e.value&&e.value.length&&t.setSessionStorage(e.value,!0)})},e.prototype.logout=function(){this.storage.removeItem("ls.stakeholder"),this.storage.removeItem("ls.token"),this.storage.removeItem("ls.user.roleId"),this.storage.clear(),this.stakeholder=new stakeholder_model_1.Stakeholder({}),this.newUser={email:null,first_name:null,last_name:null,password:null,stakeholder_type:null},this.mixpanel.event("logout"),this.mixpanel.clearUser(),this.loggedIn=!1,this._logoutSuccess.next(!0)},e.prototype.populateEntitlements=function(){var t=this,r=new Array;return this.api.getPaged("/stakeholder/entitlement/all/").subscribe(function(e){r.push.apply(r,e),t.stakeholder.entitlements=r,t.refreshStakeholder(),t._loginSuccess.next(!0)})},e.prototype.refreshStakeholder=function(){this.stakeholder=new stakeholder_model_1.Stakeholder(this.stakeholder),this.storage.setObject("ls.stakeholder",this.stakeholder)},e.prototype.register=function(){var t=this;return this.newUser.graduation&&(this.newUser=this.getNewUserForRegistration()),this.api.postWithoutAuthorization("/stakeholder/register",this.newUser).pipe(map_1.map(function(e){return t.mixpanel.event("user_registered"),e}))},e.prototype.removeProfilePicture=function(e){return this.nodeApi.delete("/users/"+e+"/profile-pic")},e.prototype.sendForgotPasswordEmail=function(e){return this.api.postWithoutAuthorization("/stakeholder/forgot",{email:e})},e.prototype.setHighSchool=function(){var e=this;return this.highSchoolService.getDetails(this.stakeholder.highschool).subscribe(function(){e.mixpanel.setHighSchool(e.stakeholder.district?e.stakeholder.district.name:"",e.stakeholder.highschool)})},e.prototype.setInterestProfilerResult=function(e){this.stakeholder.interest_profiler_result=e,this.storage.setObject("ls.stakeholder",this.stakeholder)},e.prototype.setSessionStorage=function(e,t,r){var o=this;this.storage.setItem("ls.token",e),this.api.setupHeaders(e).then(function(){o.nodeApi.setupHeaders(e),o.getStakeholderInformation(t,r),o.pnService.setToken()})},e.prototype.setStakeholder=function(e,t,r){this.stakeholder.authToken=e.token||e.authToken,this.stakeholder.id=e.id,this.setSessionStorage(this.stakeholder.authToken,t,r)},e.prototype.updateInterestProfile=function(e){var t=this;this.api.patch("/stakeholder",{interest_profiler_result:e}).subscribe(function(e){t.setInterestProfilerResult(e.interest_profiler_result)},function(e){return console.error(e)})},e.prototype.updateProfilePicture=function(e){var t=this,r=new FormData;return r.append("profile_photo",e),r.append("type",e.type),this.api.patchFile("/stakeholder/",e).pipe(map_1.map(function(e){return t.stakeholder=e}))},e.prototype.updateStakeholder=function(){var r=this;this.api.get("/stakeholder").pipe(map_1.map(function(e){var t=new stakeholder_model_1.Stakeholder(e);lodash_1.merge(r.stakeholder,t)}))},e.prototype.isJson=function(e){try{return JSON.parse(e)}catch(e){return!1}},e.prototype.showLoginErrorToast=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return t="Unable to log you in. Please try again!",r&&r._body&&this.isJson(r._body)&&(t=JSON.parse(r._body).detail),this.toastService.open(t),[2]})})},e=__decorate([core_1.Injectable({providedIn:"root"})],e)}();exports.StakeholderService=StakeholderService;